// Basic VMSS Health Check Query
// This is a starter query - more comprehensive queries will be added later

Heartbeat
| where TimeGenerated > ago(10m)
| where Computer startswith "vmss"
| summarize LastSeen = max(TimeGenerated) by Computer
| extend MinutesAgo = datetime_diff('minute', now(), LastSeen)
| extend Status = case(
    MinutesAgo <= 2, "游릭 Healthy",
    MinutesAgo <= 5, "游리 Warning", 
    "游댮 Critical"
)
| join kind=leftouter (
    VMComputer
    | where TimeGenerated > ago(1h)
    | extend VMSSName = case(
        AzureResourceName contains "_", tostring(split(AzureResourceName, "_")[0]),
        AzureResourceName
    )
    | distinct Computer, VMSSName, ResourceGroupName=AzureResourceGroup
) on Computer
| where isnotempty(VMSSName)
| summarize 
    TotalInstances = count(),
    HealthyCount = countif(Status contains "游릭"),
    WarningCount = countif(Status contains "游리"),
    CriticalCount = countif(Status contains "游댮")
    by VMSSName, ResourceGroupName
| extend OverallStatus = case(
    CriticalCount > 0, "游댮 CRITICAL",
    WarningCount > 0, "游리 WARNING",
    "游릭 HEALTHY"
)
| project VMSSName, ResourceGroupName, OverallStatus, TotalInstances, HealthyCount, WarningCount, CriticalCount
| sort by OverallStatus asc, VMSSName asc
